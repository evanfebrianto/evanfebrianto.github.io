<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Udacity Capstone Design | Evan Febrianto</title> <meta name="author" content="Evan Febrianto"/> <meta name="description" content="C++, Python, ROS, Unity"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/avatar.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://evanfebrianto.github.io/projects/sdc-udacity-capstone/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://evanfebrianto.github.io/"><span class="font-weight-bold">Evan</span> Febrianto</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/resume.pdf">Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Udacity Capstone Design</h1> <p class="post-description">C++, Python, ROS, Unity</p> <p class="post-github"> <a href="https://github.com/evanfebrianto/Udacity-SDC-Capstone" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> <span-github-link> View on GitHub </span-github-link> </a> </p> </header> <article> <h3 id="general-info">General Info</h3> <p>Carla is a self-driving vehicle built by Udacity from a customized Lincoln MKZ. Its self-driving system is divided into four primary components: <strong>Sensors</strong>, <strong>perception</strong>, <strong>planning</strong>, and <strong>control</strong> are all important parts of the process.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0" align="center"> <figure> <picture> <img src="/assets/img/capstone/carla_architecture.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="carla_architecture.png" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Carla Architecture </div> <h3 id="sensors">Sensors</h3> <p>Includes everything needed to understand its surroundings and location including <strong>cameras</strong>, <strong>lidar</strong>, <strong>GPS</strong>, <strong>radar</strong>, and <strong>IMU</strong></p> <h4 id="perception">Perception</h4> <p>Abstracts sensor inputs into object <strong>detection</strong> and <strong>localization</strong></p> <h5 id="detection">Detection</h5> <ul> <li>Vehicle detection, traffic light detection, obstacle identification, and other software pipelines are included.</li> <li>Image processing techniques include feature extraction using the Histogram of Oriented Gradients (HOG), color transforms, and spatial binning.</li> <li>For repeated detections, sliding-window or sub-sampling, as well as heat maps and bounding boxes, are used as classification methods.</li> </ul> <h5 id="localization">Localization</h5> <ul> <li>Answers the question: “Where is our car in a given map with an accuracy of 10cm or less?”</li> <li>Based on the notion that GPS is not accurate enough</li> <li>Onboard sensors are used to estimate transformation between measurements and a given map</li> </ul> <h4 id="planning">Planning</h4> <p>Path planning is broken down into for sub-components: <strong>route planning</strong>, <strong>prediction</strong>, <strong>behavioral planning</strong>, and <strong>trajectory planning</strong></p> <h5 id="route-planning">Route Planning</h5> <p>The route planning component is in charge of making high-level decisions about how to get a vehicle from one place on a map to another, such as which roads, highways, or freeways to use. This capability is similar to route planning on many smartphones and new car navigation systems.</p> <h5 id="prediction">Prediction</h5> <p>The prediction component forecasts future actions that other objects may take. If another vehicle is detected, for example, the prediction component will calculate its future course.</p> <h5 id="behavioral-planning">Behavioral Planning</h5> <p>The behavioral planning component determines the vehicle’s behavior at any given point in time. This component may issue maneuvers such as stopping at a traffic light or intersection, changing lanes, accelerating, or making a left turn onto a new street.</p> <h5 id="trajectory-planning">Trajectory Planning</h5> <p>The trajectory planning component will identify which trajectory is appropriate for executing the desired immediate behavior based on the desired immediate behavior.</p> <h3 id="control">Control</h3> <p>The control component takes the trajectory outputs and adjusts the control inputs for smooth vehicle operation using a controller algorithm like <strong>PID</strong> or <strong>MPC</strong>.</p> <h3 id="ros-architecture">ROS Architecture</h3> <p>Different nodes (written in Python or C++) connect with each other via ROS messages in the ROS Architecture. The nodes are illustrated in the diagram below, along with their communication with one another. The ROS nodes are represented as ovally outlined text boxes inside rectangular boxes, while the topics that are subscribed or published to are represented by simple rectangular boxes. The flow of communication is shown by the direction of the arrows.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0" align="center"> <figure> <picture> <img src="/assets/img/capstone/rosgraph.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="rosgraph.png" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Rosgraph visualization </div> <p>The styx server, which connects the simulator and ROS by delivering information about the car’s condition and surroundings (car’s current position, velocity, and images from the front camera) and accepting control input, is the most central node in the rqt-graph (steering, braking, throttle). The three central tasks of perception, planning, and control are represented by the other nodes.</p> <p>To recognize traffic lights, the photos are analyzed by a trained neural network within the traffic light classifier. The traffic light detector receives the percepted state of a potentially approaching traffic light, as well as the car’s current pose and a set of base waypoints from the waypoint loader. The traffic light detector can publish a waypoint near the next traffic light where the automobile should stop if the light is red using this often incoming data.</p> <p>The waypoint updater node can plan acceleration / deceleration and publish it to the waypoint follower node using the traffic light detector’s subscribed information and subscriptions to base waypoints. This node communicates with the DBW (Drive by Wire) node, which handles the duty of autonomously directing the car. It also accepts the current velocity of the automobile (straight from the car / simulator) as an input and outputs steering, braking, and throttle commands.</p> <h3 id="node-design">Node Design</h3> <div class="row"> <div class="col-sm mt-3 mt-md-0" align="center"> <figure> <picture> <img src="/assets/img/capstone/architecture.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="architecture.png" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Node Design </div> <p>The node design of those nodes that are built within this project will be discussed in this paragraph. Waypoint updater (waypoint updater.py), traffic light detector (tl detector.py), and drive by wire node (dbw node.py) are the three modules.</p> <h4 id="waypoint-updater">Waypoint Updater</h4> <p>Because it specifies which waypoints the car should follow, the waypoint updater node plays a crucial role in the planning work. The node is divided into several sections: First, there’s an import section, which imports certain Python libraries and message formats. The initialization of various constants that are not intended to be altered follows. The class WaypointUpdater is introduced after this section. The WaypointUpdater is divided into several sections. The class’s attributes are defined by the init-function, which also determines which topics the class subscribes to and which it publishes on.</p> <p>The following routines are either generic methods or callback functions that the subscribers in the init-function invoke frequently. The basic waypoints (output of waypoint loader), the car’s posture (simulator / car), and the traffic waypoint (output of tl detector) are all frequently called. The decelerate waypoints-function, which incorporates a square-root shaped deceleration towards a predefined stopline location in the case of red traffic lights, is the most essential general technique. The main function at the end of the node runs the node and logs an error if ROS is halted for any reason.</p> <h4 id="traffic-light-detection">Traffic Light Detection</h4> <p>The traffic light detector has the same structure as the Waypoint Updater, with an import or startup section followed by a class containing properties and functions. Finally, the TL detection subroutine compiles the code using its main function. The subscriptions to the current location base waypoints, the specified traffic light array containing the ground-truth coordinates of the traffic lights, and the identified color of the traffic light are all included in the TLDetector class’s init-function.</p> <p>The color of the traffic light is determined by the traffic light classifier, which is a neural network described in greater detail in the following paragraph. The callback image_cb updates the topic image color, which in turn calls the method process traffic lights(), which in turn calls the function get light state(), which receives the traffic light classification. This subroutine eventually publishes the waypoint to halt at for each upcoming detected red traffic signal.</p> <h4 id="drive-by-wire-dbw-node">Drive-By-Wire (DBW) Node</h4> <p>The dbw node, which is responsible for driving the car, is the third node that I wrote. It uses a twist controller, which uses a PID-controller and a Lowpass filter to output throttle, brake, and steering values. If dbw_enabled is set to true, the dbw node directly publishes throttle, brake, and steering commands for the car/simulator.</p> <h3 id="neural-network-design">Neural Network Design</h3> <h4 id="model">Model</h4> <p>The traffic light classification model is based on the pre-trained on the COCO dataset model “faster_rcnn_resnet101_coco” from <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md" target="_blank" rel="noopener noreferrer">Tensorflow detection model zoo</a>. Using the <a href="https://github.com/tensorflow/models/tree/master/research/object_detection" target="_blank" rel="noopener noreferrer">Tensorflow Object Detection API</a>, the simulator data model and real data model I trained.</p> <p>The models are available in the <code class="language-plaintext highlighter-rouge">ros/src/tl_detector/light_classification/train_model</code> directory.</p> <h4 id="dataset">Dataset</h4> <p>Step-by-step <a href="https://medium.com/@WuStangDan/step-by-step-tensorflow-object-detection-api-tutorial-part-1-selecting-a-model-a02b6aabe39e" target="_blank" rel="noopener noreferrer">Tensorflow Object Detection API tutorial</a> was a good guide of using the Tensorflow object detection API for traffic light classification.</p> <p>The simulator dataset was from <a href="https://drive.google.com/file/d/0Bw5abyXVejvMci03bFRueWVXX1U" target="_blank" rel="noopener noreferrer">here</a>, and the real dataset was from <a href="https://drive.google.com/file/d/0B-Eiyn-CUQtxdUZWMkFfQzdObUE" target="_blank" rel="noopener noreferrer">here</a>.</p> <h4 id="classification">Classification</h4> <p>The classification output has four categories: Red, Green, Yellow and off. To simplify, the final output will be Red or Non-Red, that is only the Red will be classified as <code class="language-plaintext highlighter-rouge">TrafficLight.RED</code>, and the other cases will be classified as <code class="language-plaintext highlighter-rouge">TrafficLight.GREEN</code>.</p> <h3 id="output">Output</h3> <h4 id="examples-of-simulator-testing-results">Examples of Simulator Testing Results:</h4> <div class="row"> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411764-80e4135a-4bc5-11e8-90de-be830ed9ffcb.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="sim_red" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411770-96841c50-4bc5-11e8-8ffb-bd41fb549881.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="sim_green" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Examples of Simulator Testing Results for Red and Green Traffic Lights </div> <div class="row"> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411774-9f08b6c4-4bc5-11e8-8921-3fefcad68e04.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="sim_yellow" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411776-a7a32d78-4bc5-11e8-8034-bbc0066d8b30.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="sim_none" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Examples of Simulator Testing Results for Yellow and Off Traffic Lights </div> <h4 id="examples-of-real-testing-results">Examples of Real Testing Results:</h4> <div class="row"> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411790-e24bf022-4bc5-11e8-95b2-55a7fd07ddf5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="real_red" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39411788-d874bbb0-4bc5-11e8-866f-1496f7f47596.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="real_green" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Examples of Real Testing Results for Red and Green Traffic Lights </div> <div class="row"> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39412245-4e0ad37a-4bce-11e8-9312-7f727d085676.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="real_yellow" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm-6 mt-3 mt-md-0" align="center"> <figure> <picture> <img src="https://user-images.githubusercontent.com/12635332/39412259-8b125892-4bce-11e8-9e59-64a689a7eb99.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="real_none" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Examples of Real Testing Results for Yellow and Off Traffic Lights </div> <h3 id="simulation-result">Simulation Result</h3> <p>Following the completion of the program, the walkthrough videos were uploaded to the Udacity project page. There was a rewrite attempt to conform to the walkthrough technique because they had a much more elegant approach to implementing the nodes.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0" align="center"> <figure> <picture> <img src="/assets/img/capstone/capstone_run.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="capstone_run.jpg" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Simulation result when car detects a traffic light </div> <p>Setting up the environment was one of the most difficult aspects of this project. I misconfigured the Python environment in the VM and was stranded for several hours. After going to the knowledge forum, one of the mentors assisted me greatly in resolving this issue.</p> <p>In order to accomplish the project, I was also perplexed by how the car should interact and operate within the test lot. For me, the test track is simple to execute because there are basic rules of the road that must be observed in order to effectively travel the track. There are also standardized movements that can be performed on the road that lead to simple vehicle behavior trajectories on the test track. The test lot, on the other hand, is troublesome and peculiar due to the lack of defined road rules and maneuvers to conduct within the test lot.</p> <p>Another thing I discovered is that while docker setup is much easier, the latency is significantly higher than VM or native setup. As a result, I used VM to run ROS nodes and my native Ubuntu 20.04 LTS to run the simulator for this project.</p> <p>Overall, this project was both tough and gratifying.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2022 Evan Febrianto. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>